{{- $isWsl := or (env "WSL_DISTRO_NAME") (env "IS_WSL") | not | not -}}
{{- $isDevcontainer := or (env "REMOTE_CONTAINERS") (env "CODESPACES") (env "VSCODE_REMOTE_CONTAINERS_SESSION") | not | not -}}
{{- $isGnome := lookPath "gnome-shell" | not | not -}}
{{- $hasHomeGPG := not ( kindIs "boolean" ( stat (joinPath .chezmoi.homeDir ".gnupg/private-keys-v1.d" ) ) ) -}}
{{- $headlessGuess := ( or $isWsl (not (or ( env "DISPLAY" ) (eq .chezmoi.os "windows" ) ) ) ) -}}
{{- $gpgconfiguredGuess := $hasHomeGPG -}}
{{- $headless := promptBool "headless" $headlessGuess -}}
{{- $gpgconfigured := promptBool "gpgconfigured" $gpgconfiguredGuess -}}
{{- $autoGit := promptBool "auto git?" true -}}

{{- $optbins := (list) -}}
{{- $usrbins := (list) -}}
{{- $usrlocalbins := (list) -}}
{{- $binpaths := (list) -}}
{{- $binroots := (list) -}}
{{- $terminfosearch := (list) -}}
{{- $termfallback := (list "linux" "vt100" ) -}}

#{{ if eq .chezmoi.os "darwin" }} Darwin
        {{- $optbins := (list) -}}
        {{- $usrbins := (list) -}}
        {{- $usrlocalbins = (list) -}}
	{{- $binpaths := (list (joinPath .chezmoi.homeDir "/.dotnet/tools") ) -}}
        {{- $binroots := (list "/" "/usr/" .chezmoi.homeDir (joinPath .chezmoi.homeDir "/.local" ) (joinPath .chezmoi.homeDir "/go" ) (joinPath .chezmoi.homeDir "/Library/flutter" ) (joinPath .chezmoi.homeDir "/.pub-cache" ) (joinPath .chezmoi.homeDir "/.cache/npm" ) ) -}}
        {{- $terminfosearch = (list "/usr/share/terminfo" "/usr/lib/share/terminfo" "/usr/share/lib/terminfo" ) -}}
        {{- $termfallback := (list "xterm" "linux" "vt100" ) -}}
#{{ else if eq .chezmoi.os "linux" }} Linux
        {{- $optbins := (list) -}}
        {{- $usrbins := (list "games" ) -}}
        {{- $usrlocalbins := (list) -}}
	{{- $binpaths := (list (joinPath .chezmoi.homeDir "/.dotnet/tools" ) ) -}}
        {{- $binroots := (list "/" "/usr/" "/usr/local/" .chezmoi.homeDir (joinPath .chezmoi.homeDir "/.local" ) (joinPath .chezmoi.homeDir "/go" ) (joinPath .chezmoi.homeDir "/libs/flutter" ) (joinPath .chezmoi.homeDir "/.pub-cache" ) (joinPath .chezmoi.homeDir "/.cache/npm" ) ) -}}
        {{- $terminfosearch := (list "/usr/share/terminfo" "/usr/lib/share/terminfo" "/usr/share/lib/terminfo" ) -}}
        {{- $termfallback := (list "rxvt" "xterm" "linux" "vt100" ) -}}
#{{ else if eq .chezmoi.os "windows" }} Windows
        {{- $optbins := (list) -}}
        {{- $usrbins := (list) -}}
        {{- $usrlocalbins := (list) -}}
	{{- $binpaths := (list) -}}
        {{- $binroots := (list) -}}
        {{- $terminfosearch := (list) -}}
        {{- $termfallback := (list "linux" "vt100" ) -}}
#{{ else if eq .chezmoi.os "solaris" }} Solaris
        {{- $optbins := (list "httrack" "SUNWsneep" "test" "VRTSvxvm" "SUNWvts" "SUNWexplo" "VRTS" "VRTSob" ) -}}
        {{- $usrbins := (list "local" "sfw" "ccs" ) -}}
        {{- $usrlocalbins := (list "mysql" "apache" "apache2" "php" ) -}}
	{{- $binpaths := (list (joinPath .chezmoi.homeDir "/.dotnet/tools" ) ) -}}
        {{- $binroots := (list "/" "/usr/" .chezmoi.homeDir (joinPath .chezmoi.homeDir "/.local" ) (joinPath .chezmoi.homeDir "/go" ) ) -}}
        {{- $terminfosearch := (list "/usr/share/terminfo" "/usr/lib/share/terminfo" "/usr/share/lib/terminfo" ) -}}
        {{- $termfallback := (list "xterm" "linux" "vt100" ) -}}
#{{ else }} Unknown OS {{ .chezmoi.os }}
        {{- $optbins := (list) -}}
        {{- $usrbins := (list) -}}
        {{- $usrlocalbins := (list) -}}
	{{- $binpaths := (list) -}}
        {{- $binroots := (list) -}}
        {{- $terminfosearch := (list) -}}
        {{- $termfallback := (list "linux" "vt100" ) -}}
#{{ end }} End OS Specific code


{{- $gitCredentialManagerLocation := findExecutable "bin/git-credential-manager" $binroots -}}

{{- if and (eq .chezmoi.os "linux") (not (stat "/usr/local/bin/git-credential-manager" )) -}}
        {{- writeToStdout "Can't find GCM: https://github.com/GitCredentialManager/git-credential-manager/releases \n" -}}
{{- end -}}

#{{- if and (eq .chezmoi.os "linux") (not (stat "/usr/bin/atuin" )) -}}
#        {{- writeToStdout "Can't find atuin: https://github.com/ellie/atuin/releases \n" -}}
#{{- end -}}

{{- if and (eq .chezmoi.os "linux") (not (lookPath "vim")) -}}
        {{- writeToStdout "Can't find vim \n" -}}
{{- end -}}

{{- if and (eq .chezmoi.os "linux") (not (lookPath "vimdiff")) -}}
        {{- writeToStdout "Can't find vimdiff \n" -}}
{{- end -}}

{{- if and (eq .chezmoi.os "linux") (not $headless) (not (lookPath "kdiff3")) -}}
        {{- writeToStdout "Can't find kdiff3 \n" -}}
{{- end -}}

{{- if and (eq .chezmoi.os "windows") (not (stat "C:\\Program Files (x86)\\GnuPG\\bin\\gpg.exe" )) -}}
        {{- writeToStdout "Missing GPG install Kleopatra https://gpg4win.org/download.html \n" -}}
{{- end -}}

[git]
    autoCommit = {{ $autoGit }}
    autoPush = {{ $autoGit }}

[data]
        headless={{ $headless }}
        gpgconfigured={{ $gpgconfigured }}
        isWsl={{ $isWsl }}
        isDevcontainer={{ $isDevcontainer }}
        isGnome={{ $isGnome }}
        gitCredentialManagerLocation={{ $gitCredentialManagerLocation }}
        optbins = [{{range $each := $optbins}}"{{$each}}", {{end}}]
        usrbins = [{{range $each := $usrbins}}"{{$each}}", {{end}}]
        usrlocalbins = [{{range $each := $usrlocalbins}}"{{$each}}", {{end}}]
        binpaths = [{{range $each := $binpaths}}"{{$each}}", {{end}}]
        binroots = [{{range $each := $binroots}}"{{$each}}", {{end}}]
        terminfosearch = [{{range $each := $terminfosearch}}"{{$each}}", {{end}}]
        termfallback = [{{range $each := $termfallback}}"{{$each}}", {{end}}]

#[diff]
#{{ if and (index . "headless") (lookPath "vimdiff") }}
#	command = "vimdiff"
#{{ else if and (eq .chezmoi.os "linux") (lookPath "kdiff3") }}
#	command = "kdiff3"
#{{ else if lookPath "vimdiff" }}
#	command = "vimdiff"
#{{ end }}

#[merge]
#	command = "vimdiff"
